{{- if .Values.mlflow.enabled }}
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: mlflow-postgres-pvc
  namespace: {{ include "chart.namespace" . }}
spec:
  accessModes:
    - {{ .Values.mlflow.postgres.persistence.accessMode | default "ReadWriteOnce" }}
  resources:
    requests:
      storage: {{ .Values.mlflow.postgres.persistence.size }}
  {{- if .Values.mlflow.postgres.persistence.storageClass }}
  storageClassName: {{ .Values.mlflow.postgres.persistence.storageClass }}
  {{- else if .Values.storageClass }}
  storageClassName: {{ .Values.storageClass }}
  {{- end }}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mlflow-postgres
  namespace: {{ include "chart.namespace" . }}
  labels:
    {{- include "chart.labels" . | nindent 4 }}
    app: mlflow-postgres
spec:
  replicas: {{ .Values.mlflow.postgres.replicas | default 1 }}
  selector:
    matchLabels:
      app: mlflow-postgres
  template:
    metadata:
      labels:
        app: mlflow-postgres
    spec:
      containers:
        - name: postgres
          image: "postgres:15"
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 5432
          env:
            - name: POSTGRES_USER
              value: {{ .Values.mlflow.postgres.user | quote }}
            - name: POSTGRES_PASSWORD
              value: {{ .Values.mlflow.postgres.password | quote }}
            - name: POSTGRES_DB
              value: {{ .Values.mlflow.postgres.db | quote }}
          volumeMounts:
            - name: postgres-data
              mountPath: /var/lib/postgresql/data
              subPath: pgdata
          livenessProbe:
            exec:
              command:
                - pg_isready
                - -U
                - {{ .Values.mlflow.postgres.user | quote }}
                - -d
                - {{ .Values.mlflow.postgres.db | quote }}
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 5
          readinessProbe:
            exec:
              command:
                - pg_isready
                - -U
                - {{ .Values.mlflow.postgres.user | quote }}
                - -d
                - {{ .Values.mlflow.postgres.db | quote }}
            initialDelaySeconds: 10
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 5
          resources:
            requests:
              memory: "256Mi"
              cpu: "250m"
            limits:
              memory: "512Mi"
              cpu: "500m"
      volumes:
        - name: postgres-data
          persistentVolumeClaim:
            claimName: mlflow-postgres-pvc
---
apiVersion: v1
kind: Service
metadata:
  name: mlflow-postgres
  namespace: {{ include "chart.namespace" . }}
  labels:
    {{- include "chart.labels" . | nindent 4 }}
    app: mlflow-postgres
spec:
  selector:
    app: mlflow-postgres
  ports:
    - protocol: TCP
      port: 5432
      targetPort: 5432
  type: ClusterIP
---
# --- MLflow Server ---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mlflow-server
  namespace: {{ include "chart.namespace" . }}
  labels:
    {{- include "chart.labels" . | nindent 4 }}
    app: mlflow-server
spec:
  replicas: {{ .Values.mlflow.replicas | default 1 }}
  selector:
    matchLabels:
      app: mlflow-server
  template:
    metadata:
      labels:
        app: mlflow-server
    spec:
      initContainers:
        # Wait for PostgreSQL
        - name: wait-for-postgres
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              echo "Waiting for MLflow PostgreSQL to be ready..."
              until nc -z mlflow-postgres.{{ include "chart.namespace" . }}.svc.cluster.local 5432; do
                echo "PostgreSQL not ready yet, retrying in 2 seconds..."
                sleep 2
              done
              echo "PostgreSQL is ready!"
        # Wait for MinIO
        - name: wait-for-minio
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              echo "Waiting for MinIO to be ready..."
              until wget -q --spider http://minio-svc.{{ include "chart.namespace" . }}.svc.cluster.local:{{ .Values.minio.service.apiPort | default 9000 }}/minio/health/ready 2>/dev/null; do
                echo "MinIO not ready yet, retrying in 2 seconds..."
                sleep 2
              done
              echo "MinIO is ready!"
        # Check MinIO bucket exists
        - name: check-minio-bucket
          image: minio/mc:latest
          env:
            - name: AWS_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: minio-credential
                  key: MINIO_ROOT_USER
            - name: AWS_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: minio-credential
                  key: MINIO_ROOT_PASSWORD
          command:
            - sh
            - -c
            - |
              echo "Configuring MinIO client..."
              mc alias set myminio http://minio-svc.{{ include "chart.namespace" . }}.svc.cluster.local:{{ .Values.minio.service.apiPort | default 9000 }} $AWS_ACCESS_KEY_ID $AWS_SECRET_ACCESS_KEY
              
              echo "Checking/Creating bucket {{ .Values.mlflow.s3.bucket }}..."
              mc mb myminio/{{ .Values.mlflow.s3.bucket }} --ignore-existing
              
              echo "Verifying bucket exists..."
              mc ls myminio/{{ .Values.mlflow.s3.bucket }}
              
              echo "MinIO bucket is ready!"
      containers:
        - name: mlflow
          image: "{{ .Values.mlflow.image.repository }}:{{ .Values.mlflow.image.tag }}"
          imagePullPolicy: {{ .Values.mlflow.image.pullPolicy | default "IfNotPresent" }}
          command:
            - mlflow
            - server
            - --backend-store-uri
            - postgresql://{{ .Values.mlflow.postgres.user }}:{{ .Values.mlflow.postgres.password }}@mlflow-postgres:5432/{{ .Values.mlflow.postgres.db }}
            - --default-artifact-root
            - s3://{{ .Values.mlflow.s3.bucket }}
            - --serve-artifacts
            - --host
            - {{ .Values.mlflow.service.host | quote }}
            - --port
            - {{ .Values.mlflow.service.port | quote }}
          ports:
            - containerPort: {{ .Values.mlflow.service.port | default 5000 }}
              name: http
          env:
            # S3/MinIO Configuration
            - name: MLFLOW_S3_ENDPOINT_URL
              value: "http://minio-svc:{{ .Values.minio.service.apiPort | default 9000 }}"
            - name: MLFLOW_S3_IGNORE_TLS
              value: "true"
            - name: AWS_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: minio-credential
                  key: MINIO_ROOT_USER
            - name: AWS_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: minio-credential
                  key: MINIO_ROOT_PASSWORD
          readinessProbe:
            httpGet:
              path: /health
              port: {{ .Values.mlflow.service.port | default 5000 }}
            initialDelaySeconds: 15
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
          livenessProbe:
            httpGet:
              path: /health
              port: {{ .Values.mlflow.service.port | default 5000 }}
            initialDelaySeconds: 30
            periodSeconds: 15
            timeoutSeconds: 5
            failureThreshold: 3
          resources:
            {{- toYaml .Values.mlflow.resources | nindent 12 }}
---
apiVersion: v1
kind: Service
metadata:
  name: mlflow-svc
  namespace: {{ include "chart.namespace" . }}
  labels:
    {{- include "chart.labels" . | nindent 4 }}
    app: mlflow-server
spec:
  selector:
    app: mlflow-server
  ports:
    - protocol: TCP
      port: {{ .Values.mlflow.service.port | default 5000 }}
      targetPort: {{ .Values.mlflow.service.port | default 5000 }}
      name: http
  type: {{ .Values.mlflow.service.type | default "ClusterIP" }}
{{- end }}