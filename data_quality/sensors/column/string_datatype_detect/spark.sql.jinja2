{% import 'dialects/spark.sql.jinja2' as lib with context -%}

SELECT
    CASE 
        WHEN COUNT({{ lib.render_target_column('analyzed_table') }}) = 0 
            THEN NULL

        WHEN COUNT({{ lib.render_target_column('analyzed_table') }}) =
            SUM(
                CASE
                    WHEN REGEXP(CAST({{ lib.render_target_column('analyzed_table') }} AS STRING), "^[-+]?\\d+$") IS TRUE
                        THEN 1
                    ELSE 0
                END
            )
            THEN 1 {# Integer #}

        WHEN COUNT({{ lib.render_target_column('analyzed_table') }}) =
            SUM(
                CASE
                    WHEN REGEXP(CAST({{ lib.render_target_column('analyzed_table') }} AS STRING), "^[+-]?[0-9]*[.,]?[0-9]+$") IS TRUE
                        THEN 1
                    ELSE 0
                END
            )
            THEN 2 {# Float/Double #}

        WHEN COUNT({{ lib.render_target_column('analyzed_table') }}) =
            SUM(
                CASE
                    WHEN REGEXP(
                        CAST({{ lib.render_target_column('analyzed_table') }} AS STRING),
                        '^(' ||
                        -- dd/MM/yyyy
                        '(0[1-9]|[12][0-9]|3[01])/(01|03|05|07|08|10|12)/\\d{4}|' ||
                        '(0[1-9]|[12][0-9]|30)/(04|06|09|11)/\\d{4}|' ||
                        '(0[1-9]|[12][0-9])/02/\\d{4}|' ||
                        -- dd-MM-yyyy
                        '(0[1-9]|[12][0-9]|3[01])-(01|03|05|07|08|10|12)-\\d{4}|' ||
                        '(0[1-9]|[12][0-9]|30)-(04|06|09|11)-\\d{4}|' ||
                        '(0[1-9]|[12][0-9])-02-\\d{4}|' ||
                        -- dd.MM.yyyy
                        '(0[1-9]|[12][0-9]|3[01])\\.(01|03|05|07|08|10|12)\\.\\d{4}|' ||
                        '(0[1-9]|[12][0-9]|30)\\.(04|06|09|11)\\.\\d{4}|' ||
                        '(0[1-9]|[12][0-9])\\.02\\.\\d{4}|' ||
                        -- yyyy/MM/dd
                        '\\d{4}/(01|03|05|07|08|10|12)/(0[1-9]|[12][0-9]|3[01])|' ||
                        '\\d{4}/(04|06|09|11)/(0[1-9]|[12][0-9]|30)|' ||
                        '\\d{4}/02/(0[1-9]|[12][0-9])|' ||
                        -- yyyy-MM-dd
                        '\\d{4}-(01|03|05|07|08|10|12)-(0[1-9]|[12][0-9]|3[01])|' ||
                        '\\d{4}-(04|06|09|11)-(0[1-9]|[12][0-9]|30)|' ||
                        '\\d{4}-02-(0[1-9]|[12][0-9])|' ||
                        -- yyyy.MM.dd
                        '\\d{4}\\.(01|03|05|07|08|10|12)\\.(0[1-9]|[12][0-9]|3[01])|' ||
                        '\\d{4}\\.(04|06|09|11)\\.(0[1-9]|[12][0-9]|30)|' ||
                        '\\d{4}\\.02\\.(0[1-9]|[12][0-9])' ||
                        ')$'
                    )
                    THEN 1
                    ELSE 0
                END
            )
            THEN 3 {# DATE dd/mm/yyyy dd-mm-yyyy dd.mm.yyyy yyyy/mm/dd yyyy-mm-dd yyyy.mm.dd #}

        WHEN COUNT({{ lib.render_target_column('analyzed_table') }}) =
            SUM(
                CASE
                    WHEN REGEXP(
                        CAST({{ lib.render_target_column('analyzed_table') }} AS STRING),
                        '^(' ||
                        -- dd/MM/yyyy HH:mm:ss
                        '(0[1-9]|[12][0-9]|3[01])/(01|03|05|07|08|10|12)/\\d{4}\\s([01][0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9]|' ||
                        '(0[1-9]|[12][0-9]|30)/(04|06|09|11)/\\d{4}\\s([01][0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9]|' ||
                        '(0[1-9]|[12][0-9])/02/\\d{4}\\s([01][0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9]|' ||
                        -- dd-MM-yyyy HH:mm:ss
                        '(0[1-9]|[12][0-9]|3[01])-(01|03|05|07|08|10|12)-\\d{4}\\s([01][0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9]|' ||
                        '(0[1-9]|[12][0-9]|30)-(04|06|09|11)-\\d{4}\\s([01][0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9]|' ||
                        '(0[1-9]|[12][0-9])-02-\\d{4}\\s([01][0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9]|' ||
                        -- dd.MM.yyyy HH:mm:ss
                        '(0[1-9]|[12][0-9]|3[01])\\.(01|03|05|07|08|10|12)\\.\\d{4}\\s([01][0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9]|' ||
                        '(0[1-9]|[12][0-9]|30)\\.(04|06|09|11)\\.\\d{4}\\s([01][0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9]|' ||
                        '(0[1-9]|[12][0-9])\\.02\\.\\d{4}\\s([01][0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9]|' ||
                        -- yyyy/MM/dd HH:mm:ss
                        '\\d{4}/(01|03|05|07|08|10|12)/(0[1-9]|[12][0-9]|3[01])\\s([01][0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9]|' ||
                        '\\d{4}/(04|06|09|11)/(0[1-9]|[12][0-9]|30)\\s([01][0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9]|' ||
                        '\\d{4}/02/(0[1-9]|[12][0-9])\\s([01][0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9]|' ||
                        -- yyyy-MM-dd HH:mm:ss
                        '\\d{4}-(01|03|05|07|08|10|12)-(0[1-9]|[12][0-9]|3[01])\\s([01][0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9]|' ||
                        '\\d{4}-(04|06|09|11)-(0[1-9]|[12][0-9]|30)\\s([01][0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9]|' ||
                        '\\d{4}-02-(0[1-9]|[12][0-9])\\s([01][0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9]|' ||
                        -- yyyy.MM.dd HH:mm:ss
                        '\\d{4}\\.(01|03|05|07|08|10|12)\\.(0[1-9]|[12][0-9]|3[01])\\s([01][0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9]|' ||
                        '\\d{4}\\.(04|06|09|11)\\.(0[1-9]|[12][0-9]|30)\\s([01][0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9]|' ||
                        '\\d{4}\\.02\\.(0[1-9]|[12][0-9])\\s([01][0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9]' ||
                        ')$'
                    ) IS TRUE
                    THEN 1
                    ELSE 0
                END
            )
            THEN 4 {# Timestamp #}

        WHEN COUNT({{ lib.render_target_column('analyzed_table') }}) =
            SUM(
                CASE
                    WHEN REGEXP(CAST({{ lib.render_target_column('analyzed_table') }} AS STRING), "^(\\b(true|false|TRUE|FALSE|yes|no|YES|NO|y|n|Y|N|t|f|T|F)\\b)$") IS TRUE
                        THEN 1
                    ELSE 0
                END
            )
            THEN 5 {# Boolean #}

        WHEN COUNT({{ lib.render_target_column('analyzed_table') }}) =
            SUM(
                CASE
                    WHEN {{ lib.render_target_column('analyzed_table') }} IS NULL
                        OR REGEXP(CAST({{ lib.render_target_column('analyzed_table') }} AS STRING), '^[-+]?\\d+$') IS TRUE
                        OR REGEXP(CAST({{ lib.render_target_column('analyzed_table') }} AS STRING), '^[+-]?([0-9]*[.])[0-9]+$') IS TRUE
                        OR REGEXP(
                            CAST({{ lib.render_target_column('analyzed_table') }} AS STRING),
                            '^(' ||
                            -- dd/MM/yyyy
                            '(0[1-9]|[12][0-9]|3[01])/(01|03|05|07|08|10|12)/\\d{4}|' ||
                            '(0[1-9]|[12][0-9]|30)/(04|06|09|11)/\\d{4}|' ||
                            '(0[1-9]|[12][0-9])/02/\\d{4}|' ||
                            -- dd-MM-yyyy
                            '(0[1-9]|[12][0-9]|3[01])-(01|03|05|07|08|10|12)-\\d{4}|' ||
                            '(0[1-9]|[12][0-9]|30)-(04|06|09|11)-\\d{4}|' ||
                            '(0[1-9]|[12][0-9])-02-\\d{4}|' ||
                            -- dd.MM.yyyy
                            '(0[1-9]|[12][0-9]|3[01])\\.(01|03|05|07|08|10|12)\\.\\d{4}|' ||
                            '(0[1-9]|[12][0-9]|30)\\.(04|06|09|11)\\.\\d{4}|' ||
                            '(0[1-9]|[12][0-9])\\.02\\.\\d{4}|' ||
                            -- yyyy/MM/dd
                            '\\d{4}/(01|03|05|07|08|10|12)/(0[1-9]|[12][0-9]|3[01])|' ||
                            '\\d{4}/(04|06|09|11)/(0[1-9]|[12][0-9]|30)|' ||
                            '\\d{4}/02/(0[1-9]|[12][0-9])|' ||
                            -- yyyy-MM-dd
                            '\\d{4}-(01|03|05|07|08|10|12)-(0[1-9]|[12][0-9]|3[01])|' ||
                            '\\d{4}-(04|06|09|11)-(0[1-9]|[12][0-9]|30)|' ||
                            '\\d{4}-02-(0[1-9]|[12][0-9])|' ||
                            -- yyyy.MM.dd
                            '\\d{4}\\.(01|03|05|07|08|10|12)\\.(0[1-9]|[12][0-9]|3[01])|' ||
                            '\\d{4}\\.(04|06|09|11)\\.(0[1-9]|[12][0-9]|30)|' ||
                            '\\d{4}\\.02\\.(0[1-9]|[12][0-9])' ||
                            ')$'
                        ) IS TRUE
                        OR REGEXP(
                            CAST({{ lib.render_target_column('analyzed_table') }} AS STRING),
                            '^(' ||
                            -- dd/MM/yyyy HH:mm:ss
                            '(0[1-9]|[12][0-9]|3[01])/(01|03|05|07|08|10|12)/\\d{4}\\s([01][0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9]|' ||
                            '(0[1-9]|[12][0-9]|30)/(04|06|09|11)/\\d{4}\\s([01][0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9]|' ||
                            '(0[1-9]|[12][0-9])/02/\\d{4}\\s([01][0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9]|' ||
                            -- dd-MM-yyyy HH:mm:ss
                            '(0[1-9]|[12][0-9]|3[01])-(01|03|05|07|08|10|12)-\\d{4}\\s([01][0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9]|' ||
                            '(0[1-9]|[12][0-9]|30)-(04|06|09|11)-\\d{4}\\s([01][0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9]|' ||
                            '(0[1-9]|[12][0-9])-02-\\d{4}\\s([01][0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9]|' ||
                            -- dd.MM.yyyy HH:mm:ss
                            '(0[1-9]|[12][0-9]|3[01])\\.(01|03|05|07|08|10|12)\\.\\d{4}\\s([01][0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9]|' ||
                            '(0[1-9]|[12][0-9]|30)\\.(04|06|09|11)\\.\\d{4}\\s([01][0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9]|' ||
                            '(0[1-9]|[12][0-9])\\.02\\.\\d{4}\\s([01][0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9]|' ||
                            -- yyyy/MM/dd HH:mm:ss
                            '\\d{4}/(01|03|05|07|08|10|12)/(0[1-9]|[12][0-9]|3[01])\\s([01][0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9]|' ||
                            '\\d{4}/(04|06|09|11)/(0[1-9]|[12][0-9]|30)\\s([01][0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9]|' ||
                            '\\d{4}/02/(0[1-9]|[12][0-9])\\s([01][0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9]|' ||
                            -- yyyy-MM-dd HH:mm:ss
                            '\\d{4}-(01|03|05|07|08|10|12)-(0[1-9]|[12][0-9]|3[01])\\s([01][0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9]|' ||
                            '\\d{4}-(04|06|09|11)-(0[1-9]|[12][0-9]|30)\\s([01][0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9]|' ||
                            '\\d{4}-02-(0[1-9]|[12][0-9])\\s([01][0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9]|' ||
                            -- yyyy.MM.dd HH:mm:ss
                            '\\d{4}\\.(01|03|05|07|08|10|12)\\.(0[1-9]|[12][0-9]|3[01])\\s([01][0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9]|' ||
                            '\\d{4}\\.(04|06|09|11)\\.(0[1-9]|[12][0-9]|30)\\s([01][0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9]|' ||
                            '\\d{4}\\.02\\.(0[1-9]|[12][0-9])\\s([01][0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9]' ||
                            ')$'
                        ) IS TRUE
                        OR REGEXP(CAST({{ lib.render_target_column('analyzed_table') }} AS STRING), '^(\\b(true|false|TRUE|FALSE|yes|no|YES|NO|y|n|Y|N|t|f|T|F)\\b)$') IS TRUE
                        THEN 0
                    WHEN TRIM(CAST({{ lib.render_target_column('analyzed_table') }} AS STRING)) <> ''
                        THEN 1
                    ELSE 0
                END
            )
            THEN 6 {# Anonther type #}
        ELSE 7 {# Mixed #}
    END AS actual_value
    {{- lib.render_data_grouping_projections('analyzed_table') }}
    {{- lib.render_time_dimension_projection('analyzed_table') }}
FROM {{ lib.render_target_table() }} AS analyzed_table
{{- lib.render_where_clause() -}}
{{- lib.render_group_by() -}}
{{- lib.render_order_by() -}}