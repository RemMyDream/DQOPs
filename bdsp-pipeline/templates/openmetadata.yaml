{{- if .Values.openmetadata.enabled }}
{{- if .Values.openmetadata.elasticsearch.enabled }}
# Elasticsearch for OpenMetadata
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: elasticsearch-pvc
  namespace: {{ include "bdsp-pipeline.namespace" . }}
  labels:
    {{- include "bdsp-pipeline.labels" . | nindent 4 }}
    app: elasticsearch
spec:
  accessModes:
    - {{ .Values.openmetadata.elasticsearch.persistence.accessMode }}
  {{- if .Values.openmetadata.elasticsearch.persistence.storageClass }}
  storageClassName: {{ .Values.openmetadata.elasticsearch.persistence.storageClass }}
  {{- end }}
  resources:
    requests:
      storage: {{ .Values.openmetadata.elasticsearch.persistence.size }}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: elasticsearch
  namespace: {{ include "bdsp-pipeline.namespace" . }}
  labels:
    {{- include "bdsp-pipeline.labels" . | nindent 4 }}
    app: elasticsearch
spec:
  replicas: 1
  selector:
    matchLabels:
      app: elasticsearch
  template:
    metadata:
      labels:
        app: elasticsearch
        {{- include "bdsp-pipeline.selectorLabels" . | nindent 8 }}
    spec:
      securityContext:
        fsGroup: {{ .Values.openmetadata.elasticsearch.securityContext.fsGroup }}
        runAsUser: {{ .Values.openmetadata.elasticsearch.securityContext.runAsUser }}
        runAsNonRoot: {{ .Values.openmetadata.elasticsearch.securityContext.runAsNonRoot }}
      initContainers:
      - name: fix-permissions
        image: busybox
        command: ["sh", "-c", "chown -R {{ .Values.openmetadata.elasticsearch.securityContext.runAsUser }}:{{ .Values.openmetadata.elasticsearch.securityContext.fsGroup }} /usr/share/elasticsearch/data"]
        volumeMounts:
        - name: elasticsearch-storage
          mountPath: /usr/share/elasticsearch/data
        securityContext:
          runAsUser: 0
          runAsNonRoot: false
      containers:
      - name: elasticsearch
        image: "{{ .Values.openmetadata.elasticsearch.image.repository }}:{{ .Values.openmetadata.elasticsearch.image.tag }}"
        imagePullPolicy: {{ .Values.openmetadata.elasticsearch.image.pullPolicy }}
        env:
        - name: discovery.type
          value: {{ .Values.openmetadata.elasticsearch.config.discoveryType }}
        - name: ES_JAVA_OPTS
          value: {{ .Values.openmetadata.elasticsearch.config.javaOpts }}
        - name: xpack.security.enabled
          value: {{ .Values.openmetadata.elasticsearch.config.xpackSecurityEnabled | quote }}
        ports:
        - containerPort: {{ .Values.openmetadata.elasticsearch.service.httpPort }}
          name: http
        - containerPort: {{ .Values.openmetadata.elasticsearch.service.transportPort }}
          name: transport
        volumeMounts:
        - name: elasticsearch-storage
          mountPath: /usr/share/elasticsearch/data
        {{- if .Values.openmetadata.elasticsearch.resources }}
        resources:
          {{- toYaml .Values.openmetadata.elasticsearch.resources | nindent 10 }}
        {{- end }}
        {{- if .Values.openmetadata.elasticsearch.livenessProbe.enabled }}
        livenessProbe:
          httpGet:
            path: /_cluster/health
            port: {{ .Values.openmetadata.elasticsearch.service.httpPort }}
          initialDelaySeconds: {{ .Values.openmetadata.elasticsearch.livenessProbe.initialDelaySeconds }}
          periodSeconds: {{ .Values.openmetadata.elasticsearch.livenessProbe.periodSeconds }}
          timeoutSeconds: {{ .Values.openmetadata.elasticsearch.livenessProbe.timeoutSeconds }}
        {{- end }}
        {{- if .Values.openmetadata.elasticsearch.readinessProbe.enabled }}
        readinessProbe:
          httpGet:
            path: /_cluster/health
            port: {{ .Values.openmetadata.elasticsearch.service.httpPort }}
          initialDelaySeconds: {{ .Values.openmetadata.elasticsearch.readinessProbe.initialDelaySeconds }}
          periodSeconds: {{ .Values.openmetadata.elasticsearch.readinessProbe.periodSeconds }}
          timeoutSeconds: {{ .Values.openmetadata.elasticsearch.readinessProbe.timeoutSeconds }}
        {{- end }}
      volumes:
      - name: elasticsearch-storage
        persistentVolumeClaim:
          claimName: elasticsearch-pvc
---
apiVersion: v1
kind: Service
metadata:
  name: elasticsearch
  namespace: {{ include "bdsp-pipeline.namespace" . }}
  labels:
    {{- include "bdsp-pipeline.labels" . | nindent 4 }}
    app: elasticsearch
spec:
  selector:
    app: elasticsearch
  ports:
  - name: http
    port: {{ .Values.openmetadata.elasticsearch.service.httpPort }}
    targetPort: {{ .Values.openmetadata.elasticsearch.service.httpPort }}
  - name: transport
    port: {{ .Values.openmetadata.elasticsearch.service.transportPort }}
    targetPort: {{ .Values.openmetadata.elasticsearch.service.transportPort }}
  type: {{ .Values.openmetadata.elasticsearch.service.type }}
{{- end }}
---
{{- if .Values.openmetadata.postgresMetadata.enabled }}
# PostgreSQL Metadata Init DB Script
apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-metadata-init-db
  namespace: {{ include "bdsp-pipeline.namespace" . }}
  labels:
    {{- include "bdsp-pipeline.labels" . | nindent 4 }}
    app: postgres-metadata
data:
  init-db.sql: |
    DO
    $$
    BEGIN
       IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = '{{ .Values.openmetadata.postgresMetadata.config.user }}') THEN
          CREATE ROLE {{ .Values.openmetadata.postgresMetadata.config.user }} LOGIN PASSWORD '{{ .Values.openmetadata.postgresMetadata.config.password }}';
       END IF;
    END
    $$;
    CREATE DATABASE {{ .Values.openmetadata.postgresMetadata.config.database }} OWNER {{ .Values.openmetadata.postgresMetadata.config.user }};

    CREATE USER {{ .Values.openmetadata.postgresMetadata.config.airflowUser }} WITH PASSWORD '{{ .Values.openmetadata.postgresMetadata.config.airflowPassword }}';
    CREATE DATABASE {{ .Values.openmetadata.postgresMetadata.config.airflowDatabase }} OWNER {{ .Values.openmetadata.postgresMetadata.config.airflowUser }};
---
# PostgreSQL Metadata
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: postgres-metadata-pvc
  namespace: {{ include "bdsp-pipeline.namespace" . }}
  labels:
    {{- include "bdsp-pipeline.labels" . | nindent 4 }}
    app: postgres-metadata
spec:
  accessModes:
    - {{ .Values.openmetadata.postgresMetadata.persistence.accessMode }}
  {{- if .Values.openmetadata.postgresMetadata.persistence.storageClass }}
  storageClassName: {{ .Values.openmetadata.postgresMetadata.persistence.storageClass }}
  {{- end }}
  resources:
    requests:
      storage: {{ .Values.openmetadata.postgresMetadata.persistence.size }}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: postgres-metadata
  namespace: {{ include "bdsp-pipeline.namespace" . }}
  labels:
    {{- include "bdsp-pipeline.labels" . | nindent 4 }}
    app: postgres-metadata
spec:
  replicas: 1
  selector:
    matchLabels:
      app: postgres-metadata
  template:
    metadata:
      labels:
        app: postgres-metadata
        {{- include "bdsp-pipeline.selectorLabels" . | nindent 8 }}
    spec:
      securityContext:
        fsGroup: 999
        runAsUser: 999
        runAsNonRoot: true
      initContainers:
      - name: fix-permissions
        image: busybox
        command: ["sh", "-c", "chown -R 999:999 /var/lib/postgresql/data && chmod 700 /var/lib/postgresql/data"]
        volumeMounts:
        - name: postgres-storage
          mountPath: /var/lib/postgresql/data
          subPath: pgdata
        securityContext:
          runAsUser: 0
          runAsNonRoot: false
      containers:
      - name: postgres
        image: "{{ .Values.openmetadata.postgresMetadata.image.repository }}:{{ .Values.openmetadata.postgresMetadata.image.tag }}"
        imagePullPolicy: {{ .Values.openmetadata.postgresMetadata.image.pullPolicy }}
        args: ["postgres", "--work_mem=10MB"]
        env:
        - name: POSTGRES_USER
          valueFrom:
            configMapKeyRef:
              name: postgres-metadata-config
              key: POSTGRES_USER
        - name: POSTGRES_PASSWORD
          valueFrom:
            configMapKeyRef:
              name: postgres-metadata-config
              key: POSTGRES_PASSWORD
        - name: PGDATA
          value: /var/lib/postgresql/data
        ports:
        - containerPort: {{ .Values.openmetadata.postgresMetadata.service.port }}
          name: postgres
        volumeMounts:
        - name: postgres-storage
          mountPath: /var/lib/postgresql/data
          subPath: pgdata
        - name: init-db-script
          mountPath: /docker-entrypoint-initdb.d/init-db.sql
          subPath: init-db.sql
          readOnly: true
        {{- if .Values.openmetadata.postgresMetadata.resources }}
        resources:
          {{- toYaml .Values.openmetadata.postgresMetadata.resources | nindent 10 }}
        {{- end }}
        {{- if .Values.openmetadata.postgresMetadata.livenessProbe.enabled }}
        livenessProbe:
          exec:
            command:
            - sh
            - -c
            - "psql -U {{ .Values.openmetadata.postgresMetadata.config.user }} -tAc 'select 1' -d {{ .Values.openmetadata.postgresMetadata.config.database }} || exit 1"
          initialDelaySeconds: {{ .Values.openmetadata.postgresMetadata.livenessProbe.initialDelaySeconds }}
          periodSeconds: {{ .Values.openmetadata.postgresMetadata.livenessProbe.periodSeconds }}
          timeoutSeconds: {{ .Values.openmetadata.postgresMetadata.livenessProbe.timeoutSeconds }}
          failureThreshold: {{ .Values.openmetadata.postgresMetadata.livenessProbe.failureThreshold }}
        {{- end }}
        {{- if .Values.openmetadata.postgresMetadata.readinessProbe.enabled }}
        readinessProbe:
          exec:
            command:
            - sh
            - -c
            - "psql -U {{ .Values.openmetadata.postgresMetadata.config.user }} -tAc 'select 1' -d {{ .Values.openmetadata.postgresMetadata.config.database }} || exit 1"
          initialDelaySeconds: {{ .Values.openmetadata.postgresMetadata.readinessProbe.initialDelaySeconds }}
          periodSeconds: {{ .Values.openmetadata.postgresMetadata.readinessProbe.periodSeconds }}
          timeoutSeconds: {{ .Values.openmetadata.postgresMetadata.readinessProbe.timeoutSeconds }}
          failureThreshold: {{ .Values.openmetadata.postgresMetadata.readinessProbe.failureThreshold }}
        {{- end }}
      volumes:
      - name: postgres-storage
        persistentVolumeClaim:
          claimName: postgres-metadata-pvc
      - name: init-db-script
        configMap:
          name: postgres-metadata-init-db
          defaultMode: 0755
---
apiVersion: v1
kind: Service
metadata:
  name: postgres-metadata
  namespace: {{ include "bdsp-pipeline.namespace" . }}
  labels:
    {{- include "bdsp-pipeline.labels" . | nindent 4 }}
    app: postgres-metadata
spec:
  selector:
    app: postgres-metadata
  ports:
  - port: {{ .Values.openmetadata.postgresMetadata.service.port }}
    targetPort: {{ .Values.openmetadata.postgresMetadata.service.port }}
    name: postgres
  type: {{ .Values.openmetadata.postgresMetadata.service.type }}
{{- end }}
---
# OpenMetadata Custom Entrypoint Script
apiVersion: v1
kind: ConfigMap
metadata:
  name: openmetadata-entrypoint
  namespace: {{ include "bdsp-pipeline.namespace" . }}
  labels:
    {{- include "bdsp-pipeline.labels" . | nindent 4 }}
    app: openmetadata-server
data:
  openmetadata-entrypoint.sh: |
    #!/bin/bash
    set -e

    LOG_PREFIX="[OM-Entrypoint]"

    log_info() {
        echo "$LOG_PREFIX [INFO] $(date '+%Y-%m-%d %H:%M:%S') - $1"
    }

    log_error() {
        echo "$LOG_PREFIX [ERROR] $(date '+%Y-%m-%d %H:%M:%S') - $1" >&2
    }

    log_warn() {
        echo "$LOG_PREFIX [WARN] $(date '+%Y-%m-%d %H:%M:%S') - $1"
    }

    DB_HOST="${DB_HOST:-postgres-metadata}"
    DB_PORT="${DB_PORT:-5432}"
    DB_USER="${DB_USER:-openmetadata_user}"
    DB_PASSWORD="${DB_USER_PASSWORD:-openmetadata_password}"
    OM_DATABASE="${OM_DATABASE:-openmetadata_db}"

    AIRFLOW_DB="${AIRFLOW_DB:-airflow_db}"
    AIRFLOW_DB_USER="${AIRFLOW_DB_USER:-airflow_user}"
    AIRFLOW_DB_PASSWORD="${AIRFLOW_DB_PASSWORD:-airflow_pass}"

    ES_HOST="${ELASTICSEARCH_HOST:-elasticsearch}"
    ES_PORT="${ELASTICSEARCH_PORT:-9200}"
    ES_SCHEME="${ELASTICSEARCH_SCHEME:-http}"

    MAX_RETRIES="${MAX_RETRIES:-30}"
    RETRY_INTERVAL="${RETRY_INTERVAL:-5}"

    SKIP_DB_INIT="${SKIP_DB_INIT:-false}"
    SKIP_AIRFLOW_INIT="${SKIP_AIRFLOW_INIT:-false}"
    SKIP_MIGRATION="${SKIP_MIGRATION:-false}"
    SKIP_ES_WAIT="${SKIP_ES_WAIT:-false}"

    wait_for_postgres() {
        log_info "Waiting for PostgreSQL at $DB_HOST:$DB_PORT..."
        
        local retries=0
        until nc -z "$DB_HOST" "$DB_PORT" 2>/dev/null || (echo > /dev/tcp/"$DB_HOST"/"$DB_PORT") 2>/dev/null; do
            retries=$((retries + 1))
            if [ $retries -ge $MAX_RETRIES ]; then
                log_error "PostgreSQL not available after $MAX_RETRIES attempts. Exiting."
                exit 1
            fi
            log_info "PostgreSQL not ready. Attempt $retries/$MAX_RETRIES. Retrying in ${RETRY_INTERVAL}s..."
            sleep $RETRY_INTERVAL
        done
        
        log_info "PostgreSQL is ready!"
    }

    wait_for_elasticsearch() {
        if [ "$SKIP_ES_WAIT" = "true" ]; then
            log_warn "Skipping Elasticsearch wait (SKIP_ES_WAIT=true)"
            return 0
        fi
        
        log_info "Waiting for Elasticsearch at $ES_SCHEME://$ES_HOST:$ES_PORT..."
        
        local retries=0
        until wget -q -O- "$ES_SCHEME://$ES_HOST:$ES_PORT/_cluster/health" 2>/dev/null | grep -qE '"status":"(green|yellow)"'; do
            retries=$((retries + 1))
            if [ $retries -ge $MAX_RETRIES ]; then
                log_error "Elasticsearch not available after $MAX_RETRIES attempts. Exiting."
                exit 1
            fi
            log_info "Elasticsearch not ready. Attempt $retries/$MAX_RETRIES. Retrying in ${RETRY_INTERVAL}s..."
            sleep $RETRY_INTERVAL
        done
        
        log_info "Elasticsearch is ready!"
    }

    init_openmetadata_db() {
        log_info "Skipping DB init (handled by PostgreSQL container)"
    }

    init_airflow_db() {
        log_info "Skipping Airflow DB init (handled by PostgreSQL container)"
    }

    run_migration() {
        if [ "$SKIP_MIGRATION" = "true" ]; then
            log_warn "Skipping migration (SKIP_MIGRATION=true)"
            return 0
        fi
        
        log_info "Running OpenMetadata database migration..."

        if [ -f "/opt/openmetadata/bootstrap/openmetadata-ops.sh" ]; then
            /opt/openmetadata/bootstrap/openmetadata-ops.sh migrate
            log_info "Migration completed successfully."
        else
            log_error "Migration script not found at ./bootstrap/openmetadata-ops.sh"
            exit 1
        fi
    }

    check_migration_status() {
        log_info "Migration completed, skipping verification (no psql client)"
    }

    main() {
        log_info "Starting OpenMetadata Unified Entrypoint"

        wait_for_postgres
        wait_for_elasticsearch

        init_openmetadata_db
        init_airflow_db

        run_migration
        check_migration_status

        log_info "Initialization complete. Starting server..."

        if [ $# -gt 0 ]; then
            exec "$@"
        else
            exec /opt/openmetadata/bin/openmetadata-server-start.sh \
                /opt/openmetadata/conf/openmetadata.yaml
        fi
    }

    main "$@"
---
{{- if .Values.openmetadata.server.enabled }}
# OpenMetadata Server
apiVersion: apps/v1
kind: Deployment
metadata:
  name: openmetadata-server
  namespace: {{ include "bdsp-pipeline.namespace" . }}
  labels:
    {{- include "bdsp-pipeline.labels" . | nindent 4 }}
    app: openmetadata-server
spec:
  replicas: {{ .Values.openmetadata.server.replicas }}
  selector:
    matchLabels:
      app: openmetadata-server
  template:
    metadata:
      labels:
        app: openmetadata-server
        {{- include "bdsp-pipeline.selectorLabels" . | nindent 8 }}
    spec:
      initContainers:
      # Wait for PostgreSQL Metadata (service_healthy)
      - name: wait-for-postgres-metadata
        image: postgres:15
        command:
        - sh
        - -c
        - |
          echo "Waiting for PostgreSQL Metadata to be ready..."
          until pg_isready -h postgres-metadata -p 5432 -U {{ .Values.openmetadata.postgresMetadata.config.user }}; do
            echo "PostgreSQL Metadata not ready yet, waiting..."
            sleep 5
          done
          echo "PostgreSQL Metadata is ready!"
      # Wait for Elasticsearch (service_healthy)
      - name: wait-for-elasticsearch
        image: curlimages/curl:8.1.2
        command:
        - sh
        - -c
        - |
          echo "Waiting for Elasticsearch to be ready..."
          until curl -s http://elasticsearch:9200/_cluster/health | grep -E '"status":"(green|yellow)"'; do
            echo "Elasticsearch not ready yet, waiting..."
            sleep 5
          done
          echo "Elasticsearch is ready!"
      containers:
      - name: openmetadata-server
        image: "{{ .Values.openmetadata.server.image.repository }}:{{ .Values.openmetadata.server.image.tag }}"
        imagePullPolicy: {{ .Values.openmetadata.server.image.pullPolicy }}
        command: ["/bin/bash", "/opt/openmetadata/entrypoint.sh"]
        envFrom:
        - configMapRef:
            name: openmetadata-server-config
        volumeMounts:
        - name: entrypoint-script
          mountPath: /opt/openmetadata/entrypoint.sh
          subPath: openmetadata-entrypoint.sh
          readOnly: true
        ports:
        - containerPort: {{ .Values.openmetadata.server.service.httpPort }}
          name: http
        - containerPort: {{ .Values.openmetadata.server.service.adminPort }}
          name: admin
        {{- if .Values.openmetadata.server.resources }}
        resources:
          {{- toYaml .Values.openmetadata.server.resources | nindent 10 }}
        {{- end }}
        {{- if .Values.openmetadata.server.livenessProbe.enabled }}
        livenessProbe:
          httpGet:
            path: /healthcheck
            port: {{ .Values.openmetadata.server.service.adminPort }}
          initialDelaySeconds: {{ .Values.openmetadata.server.livenessProbe.initialDelaySeconds }}
          periodSeconds: {{ .Values.openmetadata.server.livenessProbe.periodSeconds }}
          timeoutSeconds: {{ .Values.openmetadata.server.livenessProbe.timeoutSeconds }}
          failureThreshold: {{ .Values.openmetadata.server.livenessProbe.failureThreshold }}
        {{- end }}
        {{- if .Values.openmetadata.server.readinessProbe.enabled }}
        readinessProbe:
          httpGet:
            path: /healthcheck
            port: {{ .Values.openmetadata.server.service.adminPort }}
          initialDelaySeconds: {{ .Values.openmetadata.server.readinessProbe.initialDelaySeconds }}
          periodSeconds: {{ .Values.openmetadata.server.readinessProbe.periodSeconds }}
          timeoutSeconds: {{ .Values.openmetadata.server.readinessProbe.timeoutSeconds }}
          failureThreshold: {{ .Values.openmetadata.server.readinessProbe.failureThreshold }}
        {{- end }}
      volumes:
      - name: entrypoint-script
        configMap:
          name: openmetadata-entrypoint
          defaultMode: 0755
---
apiVersion: v1
kind: Service
metadata:
  name: openmetadata-server
  namespace: {{ include "bdsp-pipeline.namespace" . }}
  labels:
    {{- include "bdsp-pipeline.labels" . | nindent 4 }}
    app: openmetadata-server
spec:
  selector:
    app: openmetadata-server
  ports:
  - name: http
    port: {{ .Values.openmetadata.server.service.httpPort }}
    targetPort: {{ .Values.openmetadata.server.service.httpPort }}
  - name: admin
    port: {{ .Values.openmetadata.server.service.adminPort }}
    targetPort: {{ .Values.openmetadata.server.service.adminPort }}
  type: {{ .Values.openmetadata.server.service.type }}
{{- end }}
---
{{- if .Values.openmetadata.ingestion.enabled }}
# OpenMetadata Ingestion (Airflow)
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: ingestion-dag-airflow-pvc
  namespace: {{ include "bdsp-pipeline.namespace" . }}
  labels:
    {{- include "bdsp-pipeline.labels" . | nindent 4 }}
    app: ingestion
spec:
  accessModes:
    - {{ .Values.openmetadata.ingestion.persistence.dagAirflow.accessMode }}
  {{- if .Values.openmetadata.ingestion.persistence.dagAirflow.storageClass }}
  storageClassName: {{ .Values.openmetadata.ingestion.persistence.dagAirflow.storageClass }}
  {{- end }}
  resources:
    requests:
      storage: {{ .Values.openmetadata.ingestion.persistence.dagAirflow.size }}
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: ingestion-dags-pvc
  namespace: {{ include "bdsp-pipeline.namespace" . }}
  labels:
    {{- include "bdsp-pipeline.labels" . | nindent 4 }}
    app: ingestion
spec:
  accessModes:
    - {{ .Values.openmetadata.ingestion.persistence.dags.accessMode }}
  {{- if .Values.openmetadata.ingestion.persistence.dags.storageClass }}
  storageClassName: {{ .Values.openmetadata.ingestion.persistence.dags.storageClass }}
  {{- end }}
  resources:
    requests:
      storage: {{ .Values.openmetadata.ingestion.persistence.dags.size }}
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: ingestion-tmp-pvc
  namespace: {{ include "bdsp-pipeline.namespace" . }}
  labels:
    {{- include "bdsp-pipeline.labels" . | nindent 4 }}
    app: ingestion
spec:
  accessModes:
    - {{ .Values.openmetadata.ingestion.persistence.tmp.accessMode }}
  {{- if .Values.openmetadata.ingestion.persistence.tmp.storageClass }}
  storageClassName: {{ .Values.openmetadata.ingestion.persistence.tmp.storageClass }}
  {{- end }}
  resources:
    requests:
      storage: {{ .Values.openmetadata.ingestion.persistence.tmp.size }}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ingestion
  namespace: {{ include "bdsp-pipeline.namespace" . }}
  labels:
    {{- include "bdsp-pipeline.labels" . | nindent 4 }}
    app: ingestion
spec:
  replicas: {{ .Values.openmetadata.ingestion.replicas }}
  selector:
    matchLabels:
      app: ingestion
  template:
    metadata:
      labels:
        app: ingestion
        {{- include "bdsp-pipeline.selectorLabels" . | nindent 8 }}
    spec:
      initContainers:
      # Wait for Elasticsearch
      - name: wait-for-elasticsearch
        image: curlimages/curl:8.1.2
        command:
        - sh
        - -c
        - |
          echo "Waiting for Elasticsearch to be ready..."
          until curl -s http://elasticsearch:9200/_cluster/health | grep -E '"status":"(green|yellow)"'; do
            echo "Elasticsearch not ready yet, waiting..."
            sleep 5
          done
          echo "Elasticsearch is ready!"
      # Wait for PostgreSQL Metadata
      - name: wait-for-postgres-metadata
        image: postgres:15
        command:
        - sh
        - -c
        - |
          echo "Waiting for PostgreSQL Metadata to be ready..."
          until pg_isready -h postgres-metadata -p 5432 -U {{ .Values.openmetadata.postgresMetadata.config.user }}; do
            echo "PostgreSQL Metadata not ready yet, waiting..."
            sleep 5
          done
          echo "PostgreSQL Metadata is ready!"
      # Wait for OpenMetadata Server (service_started, not healthy)
      - name: wait-for-openmetadata-server
        image: curlimages/curl:8.1.2
        command:
        - sh
        - -c
        - |
          echo "Waiting for OpenMetadata Server to start..."
          until curl -sf http://openmetadata-server:{{ .Values.openmetadata.server.service.httpPort }}; do
            echo "OpenMetadata Server not started yet, waiting..."
            sleep 10
          done
          echo "OpenMetadata Server is started!"
      # Wait for setup-airflow-user job to complete
      - name: wait-for-setup-airflow-user
        image: postgres:15
        command:
        - sh
        - -c
        - |
          echo "Waiting for setup-airflow-user job to complete..."
          echo "Verifying airflow_user exists in PostgreSQL..."
          until PGPASSWORD={{ .Values.openmetadata.postgresMetadata.config.password }} psql -h postgres-metadata -U {{ .Values.openmetadata.postgresMetadata.config.user }} -d postgres -tAc "SELECT 1 FROM pg_user WHERE usename='{{ .Values.openmetadata.setupAirflowUser.airflowUser }}'" | grep -q 1; do
            echo "Airflow user not found yet, waiting for setup job to complete..."
            sleep 5
          done
          echo "Airflow user setup completed successfully!"
      containers:
      - name: ingestion
        image: "{{ .Values.openmetadata.ingestion.image.repository }}:{{ .Values.openmetadata.ingestion.image.tag }}"
        imagePullPolicy: {{ .Values.openmetadata.ingestion.image.pullPolicy }}
        envFrom:
        - configMapRef:
            name: ingestion-config
        command: ["/bin/bash"]
        args:
        - "/opt/airflow/ingestion_dependency.sh"
        ports:
        - containerPort: {{ .Values.openmetadata.ingestion.service.port }}
          name: http
        volumeMounts:
        - name: dag-airflow
          mountPath: /opt/airflow/dag_generated_configs
        - name: dags
          mountPath: /opt/airflow/dags
        - name: tmp
          mountPath: /tmp
        {{- if .Values.openmetadata.ingestion.resources }}
        resources:
          {{- toYaml .Values.openmetadata.ingestion.resources | nindent 10 }}
        {{- end }}
      volumes:
      - name: dag-airflow
        persistentVolumeClaim:
          claimName: ingestion-dag-airflow-pvc
      - name: dags
        persistentVolumeClaim:
          claimName: ingestion-dags-pvc
      - name: tmp
        persistentVolumeClaim:
          claimName: ingestion-tmp-pvc
---
apiVersion: v1
kind: Service
metadata:
  name: ingestion
  namespace: {{ include "bdsp-pipeline.namespace" . }}
  labels:
    {{- include "bdsp-pipeline.labels" . | nindent 4 }}
    app: ingestion
spec:
  selector:
    app: ingestion
  ports:
  - port: {{ .Values.openmetadata.ingestion.service.port }}
    targetPort: {{ .Values.openmetadata.ingestion.service.port }}
    name: http
  type: {{ .Values.openmetadata.ingestion.service.type }}
{{- end }}
---
{{- if .Values.openmetadata.setupAirflowUser.enabled }}
# Setup Airflow User Job
apiVersion: batch/v1
kind: Job
metadata:
  name: setup-airflow-user
  namespace: {{ include "bdsp-pipeline.namespace" . }}
  labels:
    {{- include "bdsp-pipeline.labels" . | nindent 4 }}
    app: setup-airflow-user
spec:
  template:
    metadata:
      labels:
        app: setup-airflow-user
        {{- include "bdsp-pipeline.selectorLabels" . | nindent 8 }}
    spec:
      initContainers:
      - name: wait-for-postgres
        image: {{ .Values.openmetadata.setupAirflowUser.image.repository }}:{{ .Values.openmetadata.setupAirflowUser.image.tag }}
        command:
        - sh
        - -c
        - |
          until pg_isready -h postgres-metadata -p 5432 -U {{ .Values.openmetadata.postgresMetadata.config.user }}; do
            echo "Waiting for PostgreSQL..."
            sleep 2
          done
          echo "PostgreSQL is ready!"
      containers:
      - name: setup-airflow-user
        image: {{ .Values.openmetadata.setupAirflowUser.image.repository }}:{{ .Values.openmetadata.setupAirflowUser.image.tag }}
        env:
        - name: PGPASSWORD
          valueFrom:
            secretKeyRef:
              name: postgres-metadata-secret
              key: POSTGRES_PASSWORD
        - name: PGUSER
          valueFrom:
            secretKeyRef:
              name: postgres-metadata-secret
              key: POSTGRES_USER
        command: ["/bin/bash", "/scripts/setup-airflow-user.sh"]
        volumeMounts:
        - name: setup-script
          mountPath: /scripts
      volumes:
      - name: setup-script
        configMap:
          name: setup-airflow-user-script
          defaultMode: 0755
      restartPolicy: OnFailure
  backoffLimit: {{ .Values.openmetadata.setupAirflowUser.backoffLimit }}
{{- end }}
{{- end }}
